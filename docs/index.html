<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapterhorn Terrain Visualization</title>
<script src="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/maplibre-contour@0.1.0/dist/index.min.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.css" rel="stylesheet" />
<style>
body { 
  margin: 0; 
  background: #1a1a1a; 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  color: #fff;
} 
#map { 
  width: 100vw; 
  height: 100vh; 
  position: relative;
}
#terrain-controls {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.9);
  border-radius: 10px;
  padding: 20px;
  z-index: 1000;
  font-size: 14px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  max-width: 300px;
}
#terrain-controls h4 {
  margin: 0 0 15px 0;
  color: #87CEEB;
  font-size: 1.2em;
}
.control-row {
  margin: 10px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.control-row label {
  color: #ccc;
  font-size: 12px;
}
.control-row button {
  background: #87CEEB;
  color: #000;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 11px;
}
.control-row button:hover {
  background: #5F9EA0;
}

</style>
</head>
<body>
<div id="map"></div>

<div id="terrain-controls">
  <h4>üó∫Ô∏è Terrain Features</h4>
  <p><strong>Data Source:</strong> Mapterhorn Project</p>
  <p><strong>Encoding:</strong> Terrarium</p>
  <p><strong>Technology:</strong> MapLibre GL JS + maplibre-contour</p>
  
  <div class="control-row">
    <label>Contour Lines</label>
    <button id="toggle-contours">Toggle</button>
  </div>
  
  <div class="control-row">
    <label>Contour Labels</label>
    <button id="toggle-labels">Toggle</button>
  </div>
  
  <div class="control-row">
    <label>Terrain (3D)</label>
    <button id="toggle-terrain">Toggle</button>
  </div>
  
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
    <p style="font-size: 12px; color: #999;">
      <em>Matterhorn region with live contour generation<br>
      from Mapterhorn terrain tiles in meters</em>
    </p>
  </div>
</div>

<script>
// Initialize maplibre-contour DemSource with Mapterhorn terrain tiles
var demSource = new mlcontour.DemSource({
  url: "https://tunnel.optgeo.org/martin/mapterhorn/{z}/{x}/{y}.png",
  encoding: "terrarium",
  maxzoom: 12,
  worker: true, // offload contour computation to web worker
  cacheSize: 100,
  timeoutMs: 10000
});

// Register the contour protocol with maplibre
demSource.setupMaplibre(maplibregl);

// Initialize the map centered on Matterhorn
var map = new maplibregl.Map({
  container: "map",
  zoom: 12,
  center: [7.7461, 46.0382], // Matterhorn coordinates
  pitch: 60,
  bearing: 0,
  hash: true,
  style: {
    version: 8,
    glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
    sources: {
      dem: {
        type: "raster-dem",
        encoding: "terrarium",
        tiles: [demSource.sharedDemProtocolUrl], // share cached DEM tiles
        maxzoom: 12,
        tileSize: 512
      },
      contours: {
        type: "vector",
        tiles: [
          demSource.contourProtocolUrl({
            // Keep in meters (multiplier: 1)
            multiplier: 1,
            thresholds: {
              // zoom: [minor, major] intervals in meters
              10: [100, 500],
              11: [50, 250],
              12: [25, 100],
              13: [10, 50],
              14: [5, 25],
              15: [2, 10]
            },
            elevationKey: "ele",
            levelKey: "level",
            contourLayer: "contours"
          })
        ],
        maxzoom: 15
      },
      // Basic vector tiles for landcover (to position contours above)
      "openmaptiles": {
        type: "vector",
        url: "https://demotiles.maplibre.org/tiles/tiles.json"
      }
    },
    layers: [
      // Base landcover layer
      {
        id: "landcover",
        type: "fill",
        source: "openmaptiles",
        "source-layer": "landcover",
        paint: {
          "fill-color": "#f2f0e6",
          "fill-opacity": 0.3
        }
      },
      // Hillshade for terrain relief
      {
        id: "hills",
        type: "hillshade",
        source: "dem",
        paint: {
          "hillshade-exaggeration": 0.8,
          "hillshade-shadow-color": "#5a5a5a",
          "hillshade-highlight-color": "#ffffff",
          "hillshade-accent-color": "#333333"
        }
      },
      // Contour lines (positioned above landcover)
      {
        id: "contour-lines",
        type: "line",
        source: "contours",
        "source-layer": "contours",
        paint: {
          "line-color": [
            "case",
            [">", ["get", "level"], 0],
            "#8B4513", // major contours (brown)
            "#D2691E"  // minor contours (lighter brown)
          ],
          "line-width": [
            "interpolate",
            ["linear"],
            ["zoom"],
            10, ["case", [">", ["get", "level"], 0], 1.5, 0.8],
            15, ["case", [">", ["get", "level"], 0], 2.5, 1.2]
          ],
          "line-opacity": 0.8
        },
        layout: {
          "line-join": "round",
          "line-cap": "round"
        }
      },
      // Contour labels
      {
        id: "contour-labels",
        type: "symbol",
        source: "contours",
        "source-layer": "contours",
        filter: [">", ["get", "level"], 0], // only label major contours
        paint: {
          "text-color": "#5D4E37",
          "text-halo-color": "rgba(255,255,255,0.8)",
          "text-halo-width": 2
        },
        layout: {
          "symbol-placement": "line",
          "text-anchor": "center",
          "text-size": [
            "interpolate",
            ["linear"],
            ["zoom"],
            10, 10,
            15, 14
          ],
          "text-field": [
            "concat",
            ["number-format", ["get", "ele"], {}],
            "m"
          ],
          "text-font": ["Noto Sans Bold"],
          "text-max-angle": 30,
          "text-rotation-alignment": "map"
        }
      }
    ]
  }
});

// Add 3D terrain once map loads
map.on('load', function() {
  map.setTerrain({
    source: 'dem',
    exaggeration: 1.5
  });
  
  console.log('Mapterhorn Terrain Visualization with Contour Lines');
  console.log('Data source: https://tunnel.optgeo.org/martin/mapterhorn');
  console.log('Contour generation: maplibre-contour library');
  console.log('Encoding: Terrarium format');
  console.log('Units: Meters');
});

// Control button functionality
document.getElementById('toggle-contours').addEventListener('click', function() {
  var visibility = map.getLayoutProperty('contour-lines', 'visibility');
  if (visibility === 'visible' || visibility === undefined) {
    map.setLayoutProperty('contour-lines', 'visibility', 'none');
    this.textContent = 'Show';
  } else {
    map.setLayoutProperty('contour-lines', 'visibility', 'visible');
    this.textContent = 'Hide';
  }
});

document.getElementById('toggle-labels').addEventListener('click', function() {
  var visibility = map.getLayoutProperty('contour-labels', 'visibility');
  if (visibility === 'visible' || visibility === undefined) {
    map.setLayoutProperty('contour-labels', 'visibility', 'none');
    this.textContent = 'Show';
  } else {
    map.setLayoutProperty('contour-labels', 'visibility', 'visible');
    this.textContent = 'Hide';
  }
});

document.getElementById('toggle-terrain').addEventListener('click', function() {
  var terrain = map.getTerrain();
  if (terrain) {
    map.setTerrain(null);
    this.textContent = 'Enable';
  } else {
    map.setTerrain({
      source: 'dem',
      exaggeration: 1.5
    });
    this.textContent = 'Disable';
  }
});
</script>

</body>
</html>